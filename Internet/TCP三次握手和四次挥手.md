## TCP三次握手和四次挥手

#### 1.三次握手

​	**一**、服务端新建套接字(Socket,上联应用进程，下联网络协议栈),绑定地址信息后开始监听，进入LISTEN状态。客户端新建套接字绑定地址信息后调用connect，发送连接请求SYN，并进入SYN_LISTEN状态，等待服务器的确认。

​	**二**、服务端一旦监听到连接请求，就会将连接放入内核等待队列中，并向客户端发送SYN和确认报文段ACK，进入SYN_RECD状态。

​	**三**、客户端收到SYN+ACK报文后向服务端发送报文段ACK，并进入ESTABLISHED状态，开始读写数据。服务端一旦收到客户端的确认报文，就进入ESTABLISHED状态，就可以进行读写数据了。

**Q**：为什么是三次？

**A**：因为少于三次不安全，多余三次没必要。TCP通信需要确保双方都具有数据收发的能力。

​		SYN：发送能力 ，ACK：接收确定报文

​		第一次：服务端接收客户端SYN确定客户端的发送能力和服务端的接受能力正常。

​		第二次：客户端接收服务端SYN+ACK确定自身和客户端接收发送能力正常，但服务端无法确定客户端接收能力是否正常。

​		第三次：服务端接收客户端ACK确定客户端接收能力正常且自身发送接收能力也正常

**Q**：三次握手可以携带数据吗？

**A**：第一次和第二次不可携带数据。第一次若可接收数据存在通过重复发送大量包含大量数据的SYN报文攻击服务器。

**Q**：三次握手失败，服务端如何处理？

**A**：一般有两个原因导致失败：

​		服务端没有收到SYN，则什么都不做；

​		服务端长时间没收到ACK，超时后就会发送RST重置连接报文，释放资源。

**Q**：什么是ISN？意义何在？为何要动态随机?

**A**： ISN(Initial Sequence Number)是TCP发送方的 字节数据编号的原点，告诉对方我要开始发送数据的初始化序列号。为了防止攻击者猜出后续确认号，所以是ISN是动态随机生成的。

**Q**：什么是半连接队列？

**A**：服务器会将处于SYN_RECD状态的请求连接放在一个队列里，这种队列称为半连接队列 。同理还有全连接队列，如果队列满了可能出现丢包现象。

------

#### 1.四次挥手

**一**：客户端主动调用close时，向服务端发送结束报文段FIN报，同时进入FIN_WAIT1状态

**二**：服务端收到结束报文段FIN报，服务器返回确认报文段ACK并进入CLOSE_WAIT状态，此时客户端依然可接收到服务端发送的数据。客户端收到服务端对结束报文段的确认报文段ACK后进入FIN_WAIT2状态，开始等待 服务器的结束报文段。

**三**：服务端数据发送完毕后，当服务器真正调用close关闭连接时，会向客户端发送结束报文段FIN包，此时服务器进入LAST_ACK状态，等待最后一个ACK。

**四**：客户端收到服务端发送的结束报文段，进入TIME_WAIT，并发送确认报文段ACK，服务端收到ACK后进入CLOSED状态，断开连接。客户端要等待2MSL（MSL为最大报文段生存时间，LWIP为1分钟，windows为2分钟）的时间才进入CLOSED状态。

**Q**：为什么要四次挥手？

**A**：不同与握手时可将ACK和SYN合并到一个包发送，主动发送FIN请求不代表完全断开连接，只能表示主动发送方不再发送数据，而接收方可能还需要发送数据，所以不能将服务端的FIN包和对客户端的ACK包合并发送，需先确认ACK，等服务器无需发送数据时再发送FIN包。所以需要四次数据交互。

**Q**：为什么需要等待2MSL才能进入CLOSED状态？

**A**：服务端若未收到ACK会重新发送FIN包。客户端若2MSL时间也没收到重传的FIN包，说明服务端已确认客户端发送的ACK包。

**Q**：什么是TCP连接管理中的保活机制？

**A**：默认7200s中没有数据往来，则默认每隔75s服务端发送保活数据探测报，要求客户端进行回应，若连续默认9次没收到相应，则断开连接。这些数据可通过Setsockopt接口修改
